<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RedstoneBench HCI - Enhanced</title>

<!-- React 18 + Babel -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

<style>
* { box-sizing: border-box; }

html, body {
  height: 100%;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
  background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
  color: #e6edf3;
  overflow: hidden;
}

#root { height: 100%; display: flex; flex-direction: column; }

/* ─── Animations ─────────────────────────────── */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

@keyframes slideIn {
  from { transform: translateY(-10px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes glow {
  0%, 100% { box-shadow: 0 0 5px rgba(88, 166, 255, 0.5); }
  50% { box-shadow: 0 0 20px rgba(88, 166, 255, 0.8); }
}

/* ─── Top Bar ─────────────────────────────── */
#top-bar {
  background: linear-gradient(90deg, #1f6feb 0%, #58a6ff 100%);
  color: #fff;
  padding: 8px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  backdrop-filter: blur(10px);
  font-size: 14px;
  font-weight: 500;
  animation: slideIn 0.3s ease;
}

.top-bar-section {
  display: flex;
  align-items: center;
  gap: 16px;
}

.metric {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  backdrop-filter: blur(5px);
  transition: all 0.3s ease;
}

.metric:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-1px);
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

.status-connected { background: #2ea043; box-shadow: 0 0 10px #2ea043; }
.status-connecting { background: #e3b341; box-shadow: 0 0 10px #e3b341; }
.status-disconnected { background: #f85149; box-shadow: 0 0 10px #f85149; }

/* ─── Main Layout ─────────────────────────── */
#main {
  flex: 1;
  display: grid;
  grid-template-rows: 1fr auto;
  gap: 8px;
  padding: 8px;
  overflow: hidden;
}

/* ─── Canvas Zone ──────────────────────────── */
#canvas-zone {
  position: relative;
  background: linear-gradient(145deg, #0d1117 0%, #161b22 100%);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
}

#bot-canvas {
  display: block;
  width: 100%;
  height: 100%;
  cursor: grab;
}

#bot-canvas:active { cursor: grabbing; }

/* ─── Task Panel ──────────────────────────── */
#task-panel {
  position: absolute;
  top: 16px;
  right: 16px;
  background: rgba(30, 41, 59, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(88, 166, 255, 0.3);
  border-radius: 12px;
  padding: 16px;
  width: 250px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  animation: slideIn 0.5s ease;
}

.task-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  font-weight: 600;
  color: #58a6ff;
}

.progress-container {
  margin: 12px 0;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #58a6ff, #2ea043);
  border-radius: 4px;
  transition: width 0.3s ease;
}

.task-status {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
}

.status-badge {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-running {
  background: rgba(46, 160, 67, 0.2);
  color: #2ea043;
}

.status-stopped {
  background: rgba(248, 81, 73, 0.2);
  color: #f85149;
}

/* ─── Bottom Panel ─────────────────────────── */
#bottom-panel {
  display: flex;
  gap: 8px;
  height: auto;
  min-height: 280px;
}

.panel:first-child { 
  flex: 0 0 250px; 
}

.panel:nth-child(2) { 
  flex: 1; 
}

.panel:last-child { 
  flex: 0 0 350px; 
}

.panel {
  background: rgba(30, 41, 59, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(88, 166, 255, 0.2);
  border-radius: 12px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
}

.panel:hover {
  border-color: rgba(88, 166, 255, 0.4);
}

.panel-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(88, 166, 255, 0.1);
  font-weight: 600;
  color: #58a6ff;
}

/* ─── Unit Selection ──────────────────────── */
.unit-list {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.unit-btn {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: rgba(33, 38, 45, 0.5);
  border: 1px solid transparent;
  border-radius: 8px;
  color: #e6edf3;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 13px;
  font-weight: 500;
}

.unit-btn:hover {
  background: rgba(88, 166, 255, 0.1);
  border-color: rgba(88, 166, 255, 0.3);
  transform: translateX(2px);
}

.unit-btn.selected {
  background: linear-gradient(135deg, rgba(88, 166, 255, 0.2), rgba(46, 160, 67, 0.2));
  border-color: #58a6ff;
  animation: glow 2s infinite;
}

.bot-status-icon {
  font-size: 16px;
}

/* ─── Command Center ──────────────────────── */
.bot-info {
  background: rgba(88, 166, 255, 0.05);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  min-height: 90px;
  border: 1px solid rgba(88, 166, 255, 0.1);
}

.bot-info-row {
  display: flex;
  justify-content: space-between;
  margin: 4px 0;
  font-size: 13px;
}

.bot-info-label {
  color: #7d8590;
}

.bot-info-value {
  font-weight: 500;
}

.command-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-bottom: 12px;
}

.cmd-btn {
  padding: 10px;
  background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(88, 166, 255, 0.05));
  border: 1px solid rgba(88, 166, 255, 0.2);
  border-radius: 8px;
  color: #e6edf3;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 12px;
  font-weight: 500;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.cmd-btn:hover {
  background: linear-gradient(135deg, rgba(88, 166, 255, 0.2), rgba(88, 166, 255, 0.1));
  border-color: #58a6ff;
  transform: translateY(-2px);
}

.cmd-btn.active {
  background: linear-gradient(135deg, #58a6ff, #1f6feb);
  border-color: #58a6ff;
  color: #fff;
}

.cmd-icon {
  font-size: 18px;
}

.coord-inputs {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-bottom: 12px;
}

input[type="number"] {
  padding: 8px;
  background: rgba(13, 17, 23, 0.5);
  border: 1px solid rgba(88, 166, 255, 0.2);
  border-radius: 6px;
  color: #e6edf3;
  font-size: 13px;
  transition: all 0.2s ease;
}

input[type="number"]:focus {
  outline: none;
  border-color: #58a6ff;
  background: rgba(88, 166, 255, 0.05);
}

input[type="number"]::placeholder {
  color: #7d8590;
}

#exec-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #238636, #2ea043);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

#exec-btn:hover:not(:disabled) {
  background: linear-gradient(135deg, #2ea043, #238636);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(46, 160, 67, 0.3);
}

#exec-btn:disabled {
  background: rgba(48, 54, 61, 0.5);
  cursor: not-allowed;
  opacity: 0.5;
}

.recent-activity {
  margin-top: auto;
  padding: 8px;
  background: rgba(13, 17, 23, 0.3);
  border-radius: 6px;
  font-size: 12px;
  color: #7d8590;
  min-height: 40px;
}

/* ─── Log Panel ───────────────────────────── */
#log {
  flex: 1;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  padding: 12px;
  overflow: auto;
  max-height: 200px;
  scroll-behavior: smooth;
  font-family: 'Cascadia Code', 'JetBrains Mono', Consolas, monospace;
  font-size: 11px;
  color: #79c0ff;
  line-height: 1.6;
}

.log-entry {
  padding: 4px 0;
  border-left: 2px solid transparent;
  padding-left: 8px;
  margin: 2px 0;
  transition: all 0.2s ease;
}

.log-entry:hover {
  background: rgba(88, 166, 255, 0.05);
  border-left-color: #58a6ff;
}

/* ─── Scrollbar ───────────────────────────── */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(88, 166, 255, 0.3);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(88, 166, 255, 0.5);
}

/* ─── Tooltips ────────────────────────────── */
.tooltip {
  position: absolute;
  background: rgba(30, 41, 59, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(88, 166, 255, 0.3);
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 12px;
  pointer-events: none;
  z-index: 1000;
  box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  animation: slideIn 0.2s ease;
}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {useState, useEffect, useRef, useCallback} = React;

/* ──────────────────────── DATA MODELS ──────────────────────── */
function emptyBot(id, index) {
  return {
    id: `worker_${id}`,
    index,
    position: [0, 64, 0],
    status: "IDLE",
    currentJob: "Idle - awaiting commands",
    lastLog: "Bot connected and ready"
  };
}

/* ──────────────────────── TOP BAR ──────────────────────────── */
function TopBar({elapsed, progress, workers, conn}) {
  const dotClass = conn === "connected" ? "status-connected" :
                   conn === "connecting" ? "status-connecting" : "status-disconnected";
  
  return (
    <div id="top-bar">
      <div className="top-bar-section">
        <strong>🎮 RedstoneBench HCI</strong>
      </div>
      <div className="top-bar-section">
        <div className="metric">
          <span>⏱️</span>
          <span>{elapsed}</span>
        </div>
        <div className="metric">
          <span>🔧</span>
          <span>{progress}</span>
        </div>
        <div className="metric">
          <span>🤖</span>
          <span>{workers}</span>
        </div>
        <div className="status-indicator">
          <span className={`status-dot ${dotClass}`}></span>
          <span>{conn}</span>
        </div>
      </div>
    </div>
  );
}

/* ──────────────────────── MAP CANVAS ───────────────────────── */
function MapCanvas({bots, selectedId, onSelect, selectedCommand, moveTarget, onMoveTargetChange}) {
  const canvasRef = useRef(null);
  const [{offsetX, offsetY, zoom}, setView] = useState({offsetX: 0, offsetY: 0, zoom: 1});
  const isPanning = useRef(false);
  const lastMouse = useRef({x: 0, y: 0});
  const animFrame = useRef(null);
  const scale = 0.2;

  // Coordinate helpers
  const worldToScreen = (wx, wz, width, height) => {
    const cx = width / 2, cy = height / 2;
    const sx = ((wx - offsetX) * zoom * scale) + cx;
    const sy = ((wz - offsetY) * zoom * scale) + cy;
    return [sx, sy];
  };

  const screenToWorld = (sx, sy, width, height) => {
    const cx = width / 2, cy = height / 2;
    const wx = (sx - cx) / (zoom * scale) + offsetX;
    const wz = (sy - cy) / (zoom * scale) + offsetY;
    return [wx, wz];
  };

  // Enhanced draw function
  const draw = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    
    // Clear with gradient background
    const gradient = ctx.createLinearGradient(0, 0, w, h);
    gradient.addColorStop(0, "#0d1117");
    gradient.addColorStop(1, "#161b22");
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, w, h);

    // Draw grid with varying opacity based on zoom
    const gridOpacity = Math.min(0.3, zoom * 0.3);
    ctx.strokeStyle = `rgba(255, 255, 255, ${gridOpacity})`;
    ctx.lineWidth = 1;
    
    // Major grid lines
    const step = 100;
    for (let gx = -500; gx <= 500; gx += step) {
      const [sx1, sy1] = worldToScreen(gx, -500, w, h);
      const [sx2, sy2] = worldToScreen(gx, 500, w, h);
      ctx.beginPath();
      ctx.moveTo(sx1, sy1);
      ctx.lineTo(sx2, sy2);
      ctx.stroke();
    }
    for (let gz = -500; gz <= 500; gz += step) {
      const [sx1, sy1] = worldToScreen(-500, gz, w, h);
      const [sx2, sy2] = worldToScreen(500, gz, w, h);
      ctx.beginPath();
      ctx.moveTo(sx1, sy1);
      ctx.lineTo(sx2, sy2);
      ctx.stroke();
    }

    // Origin marker
    const [ox, oy] = worldToScreen(0, 0, w, h);
    ctx.strokeStyle = "rgba(88, 166, 255, 0.2)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(ox, oy, 5, 0, 2 * Math.PI);
    ctx.stroke();

    // Draw bots with enhanced visuals
    bots.forEach(b => {
      const [sx, sy] = worldToScreen(b.position[0], b.position[2], w, h);
      
      // Bot shadow
      ctx.fillStyle = "rgba(0, 0, 0, 0.3)";
      ctx.beginPath();
      ctx.arc(sx + 2, sy + 2, 12, 0, 2 * Math.PI);
      ctx.fill();
      
      // Bot icon with status-based color
      ctx.font = "24px serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      
      if (b.status === "BUSY") {
        // Glowing effect for busy bots
        ctx.shadowBlur = 10;
        ctx.shadowColor = "#58a6ff";
        ctx.fillStyle = "#58a6ff";
      } else {
        ctx.shadowBlur = 0;
        ctx.fillStyle = "#7d8590";
      }
      
      ctx.fillText("🤖", sx, sy);
      ctx.shadowBlur = 0;
      
      // Selection ring
      if (b.id === selectedId) {
        ctx.strokeStyle = "#ffd700";
        ctx.lineWidth = 3;
        ctx.setLineDash([5, 3]);
        ctx.beginPath();
        ctx.arc(sx, sy, 18, 0, 2 * Math.PI);
        ctx.stroke();
        ctx.setLineDash([]);
      }
      
      // Bot label
      ctx.fillStyle = "rgba(230, 237, 243, 0.8)";
      ctx.font = "10px sans-serif";
      ctx.fillText(b.id, sx, sy + 25);
    });

    // Draw move target
    if (selectedCommand === "move_to" && moveTarget) {
      const [sx, sy] = worldToScreen(moveTarget.x, moveTarget.z, w, h);
      
      // Target animation
      const time = Date.now() / 1000;
      const pulse = Math.sin(time * 3) * 0.2 + 0.8;
      
      ctx.strokeStyle = `rgba(255, 0, 0, ${pulse})`;
      ctx.lineWidth = 2;
      const armLength = 25;
      
      // Crosshair
      ctx.beginPath();
      ctx.moveTo(sx - armLength, sy);
      ctx.lineTo(sx + armLength, sy);
      ctx.moveTo(sx, sy - armLength);
      ctx.lineTo(sx, sy + armLength);
      ctx.stroke();
      
      // Circle
      ctx.beginPath();
      ctx.arc(sx, sy, 15, 0, 2 * Math.PI);
      ctx.stroke();
      
      // Coordinates label
      ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
      ctx.font = "11px monospace";
      ctx.fillText(`(${moveTarget.x}, ${moveTarget.z})`, sx, sy + 35);
    }
  };

  // Animation loop
  useEffect(() => {
    const animate = () => {
      draw();
      animFrame.current = requestAnimationFrame(animate);
    };
    animate();
    return () => {
      if (animFrame.current) {
        cancelAnimationFrame(animFrame.current);
      }
    };
  }, [bots, selectedId, offsetX, offsetY, zoom, selectedCommand, moveTarget]);

  // Canvas resize
  useEffect(() => {
    const canvas = canvasRef.current;
    const resize = () => {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
    };
    resize();
    window.addEventListener("resize", resize);
    return () => window.removeEventListener("resize", resize);
  }, []);

  // Mouse events
  const onDown = e => {
    isPanning.current = true;
    lastMouse.current = {x: e.clientX, y: e.clientY};
    canvasRef.current.style.cursor = "grabbing";
  };

  const onMove = e => {
    if (!isPanning.current) return;
    const dx = e.clientX - lastMouse.current.x;
    const dy = e.clientY - lastMouse.current.y;
    setView(v => ({...v, offsetX: v.offsetX - dx / (v.zoom * scale), offsetY: v.offsetY - dy / (v.zoom * scale)}));
    lastMouse.current = {x: e.clientX, y: e.clientY};
  };

  const onUp = () => {
    isPanning.current = false;
    canvasRef.current.style.cursor = selectedCommand === "move_to" ? "crosshair" : "grab";
  };

  const onWheel = e => {
    e.preventDefault();
    const delta = e.deltaY < 0 ? 1.1 : 0.9;
    setView(v => ({...v, zoom: Math.max(0.2, Math.min(20, v.zoom * delta))}));
  };

  const onClick = e => {
    const rect = canvasRef.current.getBoundingClientRect();
    const [wx, wz] = screenToWorld(e.clientX - rect.left, e.clientY - rect.top, canvasRef.current.width, canvasRef.current.height);
    
    let closest = null, min = 30 / scale / zoom;
    bots.forEach(b => {
      const d = Math.hypot(b.position[0] - wx, b.position[2] - wz);
      if (d < min) {
        min = d;
        closest = b;
      }
    });
    
    if (closest) {
      onSelect(closest.id);
    } else if (selectedCommand === "move_to") {
      onMoveTargetChange({x: Math.round(wx), y: 64, z: Math.round(wz)});
    }
  };

  return (
    <canvas
      id="bot-canvas"
      ref={canvasRef}
      style={{cursor: selectedCommand === "move_to" ? "crosshair" : "grab"}}
      onMouseDown={onDown}
      onMouseMove={onMove}
      onMouseUp={onUp}
      onMouseLeave={onUp}
      onWheel={onWheel}
      onClick={onClick}
    />
  );
}

/* ──────────────────────── UNIT SELECTION ────────────────────── */
function UnitSelection({bots, selectedId, onSelect}) {
  return (
    <div className="unit-list">
      {bots.map(b => {
        const icon = b.status === "BUSY" ? "⚡" : "💤";
        return (
          <button
            key={b.id}
            className={`unit-btn ${selectedId === b.id ? "selected" : ""}`}
            onClick={() => onSelect(b.id)}
          >
            <span>{b.id}</span>
            <span className="bot-status-icon">{icon}</span>
          </button>
        );
      })}
    </div>
  );
}

/* ──────────────────────── COMMAND CENTER ───────────────────── */
function CommandCenter({bot, onSend, selectedCommand, onCommandChange, moveTarget, onMoveTargetChange}) {
  const disabled = !bot;

  const exec = () => {
    if (!bot) return;
    if (selectedCommand === "move_to") {
      if (!moveTarget) {
        alert("Please set target coordinates or click on the map");
        return;
      }
      onSend({
        type: "command",
        cmd: "move_to",
        bot_id: bot.index,
        parameters: {target: [moveTarget.x, moveTarget.y, moveTarget.z]}
      });
    } else if (selectedCommand === "cancel_job") {
      onSend({type: "command", cmd: "cancel", bot_id: bot.index});
    } else {
      onSend({type: "command", cmd: "status", bot_id: bot.index});
    }
  };

  return (
    <React.Fragment>
      <div className="bot-info">
        {bot ? (
          <React.Fragment>
            <div className="bot-info-row">
              <span className="bot-info-label">Unit:</span>
              <span className="bot-info-value">{bot.id}</span>
            </div>
            <div className="bot-info-row">
              <span className="bot-info-label">Status:</span>
              <span className="bot-info-value" style={{color: bot.status === "BUSY" ? "#2ea043" : "#e3b341"}}>
                {bot.status}
              </span>
            </div>
            <div className="bot-info-row">
              <span className="bot-info-label">Position:</span>
              <span className="bot-info-value">{bot.position.map(p => p.toFixed(1)).join(", ")}</span>
            </div>
            <div className="bot-info-row">
              <span className="bot-info-label">Current Job:</span>
              <span className="bot-info-value">{bot.currentJob}</span>
            </div>
          </React.Fragment>
        ) : (
          <div style={{textAlign: "center", color: "#7d8590"}}>
            No unit selected
          </div>
        )}
      </div>

      <div className="command-grid">
        <button 
          className={`cmd-btn ${selectedCommand === "move_to" ? "active" : ""}`}
          onClick={() => onCommandChange("move_to")}
        >
          <span className="cmd-icon">🎯</span>
          <span>Move</span>
        </button>
        <button 
          className={`cmd-btn ${selectedCommand === "cancel_job" ? "active" : ""}`}
          onClick={() => onCommandChange("cancel_job")}
        >
          <span className="cmd-icon">⛔</span>
          <span>Cancel</span>
        </button>
        <button 
          className={`cmd-btn ${selectedCommand === "query" ? "active" : ""}`}
          onClick={() => onCommandChange("query")}
        >
          <span className="cmd-icon">📊</span>
          <span>Query</span>
        </button>
      </div>

      {selectedCommand === "move_to" && (
        <div className="coord-inputs">
          <input
            type="number"
            placeholder="X"
            value={(moveTarget && moveTarget.x) || ""}
            onChange={e => onMoveTargetChange({
              x: parseInt(e.target.value) || 0,
              y: (moveTarget && moveTarget.y) || 64,
              z: (moveTarget && moveTarget.z) || 0
            })}
          />
          <input
            type="number"
            placeholder="Y"
            value={(moveTarget && moveTarget.y) || ""}
            onChange={e => onMoveTargetChange({
              x: (moveTarget && moveTarget.x) || 0,
              y: parseInt(e.target.value) || 0,
              z: (moveTarget && moveTarget.z) || 0
            })}
          />
          <input
            type="number"
            placeholder="Z"
            value={(moveTarget && moveTarget.z) || ""}
            onChange={e => onMoveTargetChange({
              x: (moveTarget && moveTarget.x) || 0,
              y: (moveTarget && moveTarget.y) || 64,
              z: parseInt(e.target.value) || 0
            })}
          />
        </div>
      )}

      <button id="exec-btn" onClick={exec} disabled={disabled}>
        Execute Command
      </button>

      <div className="recent-activity">
        {bot ? `📝 ${bot.lastLog}` : ""}
      </div>
    </React.Fragment>
  );
}

/* ──────────────────────── TASK PANEL ───────────────────────── */
function TaskPanel({stats}) {
  const pct = Math.round((stats.completedBlocks / stats.totalBlocks) * 100);
  
  return (
    <div id="task-panel">
      <div className="task-header">
        <span>📊</span>
        <span>Task Progress</span>
      </div>
      
      <div className="progress-container">
        <div className="progress-bar">
          <div className="progress-fill" style={{width: `${pct}%`}}></div>
        </div>
        <div style={{fontSize: "12px", marginTop: "4px", color: "#7d8590"}}>
          {stats.completedBlocks} / {stats.totalBlocks} blocks ({pct}%)
        </div>
      </div>
      
      <div className="task-status">
        <span>Status:</span>
        <span className={`status-badge ${stats.isRunning ? "status-running" : "status-stopped"}`}>
          {stats.isRunning ? "Running" : "Stopped"}
        </span>
      </div>
    </div>
  );
}

/* ──────────────────────── MAIN APP ─────────────────────────── */
function App() {
  const [bots, setBots] = useState({});
  const [conn, setConn] = useState("connecting");
  const [selected, setSelected] = useState(null);
  const [logs, setLogs] = useState([]);
  const [stats, setStats] = useState({
    startTime: Date.now(),
    workerCount: 0,
    totalBlocks: 85,
    completedBlocks: 0,
    isRunning: true
  });
  const [selectedCommand, setSelectedCommand] = useState("move_to");
  const [moveTarget, setMoveTarget] = useState(null);
  const startTimeRef = useRef(Date.now());
  const wsRef = useRef(null);

  // Elapsed time
  const [elapsed, setElapsed] = useState("0:00");
  useEffect(() => {
    const id = setInterval(() => {
      const diff = Math.floor((Date.now() - startTimeRef.current) / 1000);
      setElapsed(`${Math.floor(diff / 60)}:${(diff % 60).toString().padStart(2, "0")}`);
    }, 1000);
    return () => clearInterval(id);
  }, []);

  // WebSocket connection
  useEffect(() => {
    let ws;
    const connect = () => {
      setConn("connecting");
      ws = new WebSocket("ws://localhost:8080");
      wsRef.current = ws;

      ws.onopen = () => {
        setConn("connected");
        const statusRequest = {"type": "get_status_all"};
        console.log("Sending WebSocket message:", statusRequest);
        ws.send(JSON.stringify(statusRequest));
      };

      ws.onmessage = e => {
        const msg = JSON.parse(e.data);
        console.log("Received WebSocket message:", msg);
        if (msg.type === "status_response_all") {
          setBots(prev => {
            const clone = {...prev};
            Object.entries(msg.bots).forEach(([id, data]) => {
              const idx = parseInt(id, 10);
              const key = `worker_${idx}`;
              clone[key] = clone[key] || emptyBot(idx, idx);
              const b = clone[key];
              b.status = data.status;
              b.position = data.result.bot_position;
              b.currentJob = data.result.current_job;
            });
            setStats(s => ({...s, workerCount: Object.keys(clone).length}));
            return clone;
          });
        } else {
          const botId = msg.bot_id;
          let txt = "";
          if (msg.type === "job_start") txt = `Bot ${botId} started job: ${msg.command}`;
          else if (msg.type === "job_complete") txt = `Bot ${botId} completed job.`;
          else if (msg.type === "job_failed") txt = `Bot ${botId} failed job.`;
          else if (msg.type === "command_response") txt = `Command '${msg.cmd}' for Bot ${botId}: ${msg.status}.`;
          else txt = JSON.stringify(msg);
          
          setLogs(l => [`${new Date().toLocaleTimeString()} ─ ${txt}`, ...l.slice(0, 499)]);
          setBots(prev => {
            const key = `worker_${botId}`;
            if (prev[key]) prev[key] = {...prev[key], lastLog: txt};
            return {...prev};
          });
        }
      };

      ws.onclose = () => {
        setConn("disconnected");
        setTimeout(connect, 2000);
      };
      
      ws.onerror = () => ws.close();
    };
    
    connect();
    return () => ws && ws.close();
  }, []);

  // Send command
  const sendCmd = cmd => {
    if (wsRef.current && wsRef.current.readyState === 1) {
      console.log("Sending WebSocket message:", cmd);
      wsRef.current.send(JSON.stringify(cmd));
      setLogs(l => [`${new Date().toLocaleTimeString()} ─ Sent command: ${cmd.cmd}`, ...l]);
    } else {
      alert("WebSocket not connected");
    }
  };

  const botArray = Object.values(bots);
  const selectedBot = bots[selected] || null;

  return (
    <React.Fragment>
      <TopBar
        elapsed={elapsed}
        progress={`${stats.completedBlocks}/${stats.totalBlocks}`}
        workers={`${stats.workerCount} Bots`}
        conn={conn}
      />
      <div id="main">
        <div id="canvas-zone">
          <MapCanvas
            bots={botArray}
            selectedId={selected}
            onSelect={setSelected}
            selectedCommand={selectedCommand}
            moveTarget={moveTarget}
            onMoveTargetChange={setMoveTarget}
          />
          <TaskPanel stats={stats} />
        </div>

        <div id="bottom-panel">
          <div className="panel">
            <div className="panel-header">
              <span>🤖</span>
              <span>Unit Selection</span>
            </div>
            <UnitSelection
              bots={botArray}
              selectedId={selected}
              onSelect={setSelected}
            />
          </div>

          <div className="panel">
            <div className="panel-header">
              <span>🎮</span>
              <span>Command Center</span>
            </div>
            <CommandCenter
              bot={selectedBot}
              onSend={sendCmd}
              selectedCommand={selectedCommand}
              onCommandChange={setSelectedCommand}
              moveTarget={moveTarget}
              onMoveTargetChange={setMoveTarget}
            />
          </div>

          <div className="panel">
            <div className="panel-header">
              <span>📜</span>
              <span>System Log</span>
            </div>
            <div id="log">
              {logs.map((log, i) => (
                <div key={i} className="log-entry">{log}</div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </React.Fragment>
  );
}

/* ──────────────────────── RENDER ──────────────────────────── */
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>